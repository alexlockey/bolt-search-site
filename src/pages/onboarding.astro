---
import Layout from '../layouts/Layout.astro';

const title = "Contractor Onboarding";
const description = "Complete this onboarding form to get set up as a contractor with Bolt Search. All information is handled securely.";
---

<Layout title={title} description={description} noindex={true}>
  <section class="onboarding-hero">
    <div class="container-wide">
      <div style="max-width: 640px;">
        <p class="section-label">Contractor Setup</p>
        <h1>Onboarding Form</h1>
        <p style="font-size: 1.0625rem; margin-top: var(--space-md); color: var(--color-fg-muted);">
          Please complete all sections below. All information is handled securely.
        </p>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container-wide" style="max-width: 780px;">
      <form
        class="onboarding-form"
        action="/api/onboarding"
        method="POST"
        enctype="multipart/form-data"
      >

        <!-- Section 1: Personal Details -->
        <fieldset>
          <legend>Personal Details</legend>
          <div class="form-grid">
            <div class="form-group full-width">
              <label for="fullName">Full Name <span class="required">*</span></label>
              <input type="text" id="fullName" name="Full Name" required />
            </div>
            <div class="form-group">
              <label for="dob">Date of Birth <span class="required">*</span></label>
              <input type="date" id="dob" name="Date of Birth" required />
            </div>
            <div class="form-group">
              <label for="nationality">Nationality <span class="required">*</span></label>
              <input type="text" id="nationality" name="Nationality" required />
            </div>
            <div class="form-group">
              <label for="contactEmail">Contact Email <span class="required">*</span></label>
              <input type="email" id="contactEmail" name="Contact Email" required />
            </div>
            <div class="form-group">
              <label for="contactPhone">Contact Phone Number <span class="required">*</span></label>
              <input type="tel" id="contactPhone" name="Contact Phone" required />
            </div>
            <div class="form-group full-width">
              <label for="homeAddress">Home Address <span class="required">*</span></label>
              <textarea id="homeAddress" name="Home Address" rows="3" required></textarea>
            </div>
          </div>
        </fieldset>

        <!-- Section 2: Trading Entity -->
        <fieldset>
          <legend>Trading Entity Details</legend>
          <div class="form-grid">
            <div class="form-group full-width">
              <label>How will you be trading? <span class="required">*</span></label>
              <div class="radio-group">
                <label class="radio-label">
                  <input type="radio" name="Trading Type" value="Limited Company" required />
                  <span>Limited Company</span>
                </label>
                <label class="radio-label">
                  <input type="radio" name="Trading Type" value="Umbrella Company" />
                  <span>Umbrella Company</span>
                </label>
                <label class="radio-label">
                  <input type="radio" name="Trading Type" value="Sole Trader" />
                  <span>Sole Trader</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Limited Company fields -->
          <div id="limitedFields" class="conditional-section" style="display: none;">
            <h4>Limited Company Details</h4>
            <div class="form-grid">
              <div class="form-group">
                <label for="companyName">Company Name</label>
                <input type="text" id="companyName" name="Company Name" />
              </div>
              <div class="form-group">
                <label for="companyNumber">Company Number</label>
                <input type="text" id="companyNumber" name="Company Number" />
              </div>
              <div class="form-group">
                <label for="vatNumber">VAT Registration Number</label>
                <input type="text" id="vatNumber" name="VAT Number" placeholder="If applicable" />
              </div>
              <div class="form-group">
                <label for="registeredAddress">Registered Address</label>
                <input type="text" id="registeredAddress" name="Registered Address" />
              </div>
              <div class="form-group">
                <label for="bankSortCode">Bank Sort Code</label>
                <input type="text" id="bankSortCode" name="Bank Sort Code" placeholder="00-00-00" />
              </div>
              <div class="form-group">
                <label for="bankAccount">Bank Account Number</label>
                <input type="text" id="bankAccount" name="Bank Account Number" />
              </div>
              <div class="form-group full-width">
                <label for="accountHolder">Account Holder Name</label>
                <input type="text" id="accountHolder" name="Account Holder Name" />
              </div>
            </div>
          </div>

          <!-- Umbrella Company fields -->
          <div id="umbrellaFields" class="conditional-section" style="display: none;">
            <h4>Umbrella Company Details</h4>
            <div class="form-grid">
              <div class="form-group">
                <label for="umbrellaName">Umbrella Company Name</label>
                <input type="text" id="umbrellaName" name="Umbrella Company Name" />
              </div>
              <div class="form-group">
                <label for="umbrellaEmail">Umbrella Contact Email</label>
                <input type="email" id="umbrellaEmail" name="Umbrella Contact Email" />
              </div>
              <div class="form-group full-width">
                <label for="umbrellaAddress">Umbrella Registered Address</label>
                <input type="text" id="umbrellaAddress" name="Umbrella Registered Address" />
              </div>
            </div>
          </div>
        </fieldset>

        <!-- Section 3: Right to Work -->
        <fieldset>
          <legend>Right to Work in the UK</legend>
          <div class="form-grid">
            <div class="form-group full-width">
              <label>Do you have the right to work in the UK? <span class="required">*</span></label>
              <div class="radio-group">
                <label class="radio-label">
                  <input type="radio" name="Right to Work" value="Yes" required />
                  <span>Yes</span>
                </label>
                <label class="radio-label">
                  <input type="radio" name="Right to Work" value="No" />
                  <span>No</span>
                </label>
              </div>
            </div>
            <div class="form-group full-width">
              <label for="rtwType">Type of Right to Work Documentation</label>
              <input type="text" id="rtwType" name="Right to Work Documentation Type" placeholder="e.g. British Passport, Settled Status, Visa Type" />
            </div>
            <div class="form-group full-width">
              <label for="rtwUpload">Upload Right to Work Documentation</label>
              <input type="file" id="rtwUpload" name="attachment" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" />
              <span class="form-hint">Accepted: PDF, JPG, PNG, DOC. Max 5MB.</span>
            </div>
          </div>
        </fieldset>

        <!-- Section 4: Qualifications -->
        <fieldset>
          <legend>Professional Qualifications</legend>
          <div class="form-grid">
            <div class="form-group full-width">
              <label for="qualifications">Relevant qualifications, certifications, or professional memberships</label>
              <textarea id="qualifications" name="Professional Qualifications" rows="4" placeholder="List any relevant qualifications..."></textarea>
            </div>
          </div>
        </fieldset>

        <!-- Section 5: Insurance -->
        <fieldset id="insuranceSection">
          <legend>Insurance <span class="legend-note">(if operating as Limited Company)</span></legend>
          <div class="form-grid">
            <div class="form-group">
              <label>Professional Indemnity Insurance</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input type="radio" name="Professional Indemnity Insurance" value="Yes" />
                  <span>Yes</span>
                </label>
                <label class="radio-label">
                  <input type="radio" name="Professional Indemnity Insurance" value="No" />
                  <span>No</span>
                </label>
              </div>
            </div>
            <div class="form-group">
              <label>Public Liability Insurance</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input type="radio" name="Public Liability Insurance" value="Yes" />
                  <span>Yes</span>
                </label>
                <label class="radio-label">
                  <input type="radio" name="Public Liability Insurance" value="No" />
                  <span>No</span>
                </label>
              </div>
            </div>
            <div class="form-group full-width">
              <label for="insuranceUpload">Upload Insurance Certificate(s)</label>
              <input type="file" id="insuranceUpload" name="attachment" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" multiple />
              <span class="form-hint">Upload policy details or certificates if applicable. Max 5MB each.</span>
            </div>
          </div>
        </fieldset>

        <!-- Section 6: Emergency Contact -->
        <fieldset>
          <legend>Emergency Contact</legend>
          <div class="form-grid">
            <div class="form-group">
              <label for="emergencyName">Name <span class="required">*</span></label>
              <input type="text" id="emergencyName" name="Emergency Contact Name" required />
            </div>
            <div class="form-group">
              <label for="emergencyRelationship">Relationship <span class="required">*</span></label>
              <input type="text" id="emergencyRelationship" name="Emergency Contact Relationship" required />
            </div>
            <div class="form-group">
              <label for="emergencyPhone">Phone Number <span class="required">*</span></label>
              <input type="tel" id="emergencyPhone" name="Emergency Contact Phone" required />
            </div>
          </div>
        </fieldset>

        <div class="form-submit">
          <button type="submit" class="btn btn-primary" style="width: 100%;">
            Submit Onboarding Form <span aria-hidden="true">&rarr;</span>
          </button>
          <p class="form-disclaimer">
            Your information will be sent securely to the Bolt Search team.
          </p>
        </div>
      </form>
    </div>
  </section>
</Layout>

<script>
  // Show/hide conditional sections based on trading type
  document.querySelectorAll('input[name="Trading Type"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      const target = (e.target as HTMLInputElement).value;
      const limited = document.getElementById('limitedFields');
      const umbrella = document.getElementById('umbrellaFields');
      if (limited) limited.style.display = target === 'Limited Company' ? 'block' : 'none';
      if (umbrella) umbrella.style.display = target === 'Umbrella Company' ? 'block' : 'none';
    });
  });

  // Helper: convert File to base64
  function fileToBase64(file: File): Promise<string> {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const result = reader.result as string;
        resolve(result.split(',')[1]); // strip data:...;base64, prefix
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // Validation helpers
  function clearErrors() {
    document.querySelectorAll('.field-error').forEach(el => el.remove());
    document.querySelectorAll('.fieldset-error').forEach(el => el.classList.remove('fieldset-error'));
  }

  function showError(fieldset: Element, message: string) {
    fieldset.classList.add('fieldset-error');
    // Add error message after the legend
    const legend = fieldset.querySelector('legend');
    if (legend && !fieldset.querySelector('.field-error')) {
      const err = document.createElement('p');
      err.className = 'field-error';
      err.textContent = message;
      legend.insertAdjacentElement('afterend', err);
    }
  }

  function validateForm(): boolean {
    clearErrors();
    const errors: Element[] = [];
    const fieldsets = form.querySelectorAll('fieldset');

    // Section 1: Personal Details
    const personal = fieldsets[0];
    const personalRequired = personal.querySelectorAll('[required]') as NodeListOf<HTMLInputElement | HTMLTextAreaElement>;
    let personalMissing = false;
    personalRequired.forEach(field => {
      if (!field.value.trim()) personalMissing = true;
    });
    if (personalMissing) {
      showError(personal, 'Please fill in all required personal details.');
      errors.push(personal);
    }

    // Section 2: Trading Entity
    const trading = fieldsets[1];
    const tradingTypeSelected = form.querySelector('input[name="Trading Type"]:checked') as HTMLInputElement;
    if (!tradingTypeSelected) {
      showError(trading, 'Please select how you will be trading.');
      errors.push(trading);
    }

    // Section 3: Right to Work
    const rtw = fieldsets[2];
    const rtwSelected = form.querySelector('input[name="Right to Work"]:checked') as HTMLInputElement;
    if (!rtwSelected) {
      showError(rtw, 'Please confirm your right to work in the UK.');
      errors.push(rtw);
    }

    // Section 6: Emergency Contact
    const emergency = fieldsets[5];
    const emergencyRequired = emergency.querySelectorAll('[required]') as NodeListOf<HTMLInputElement>;
    let emergencyMissing = false;
    emergencyRequired.forEach(field => {
      if (!field.value.trim()) emergencyMissing = true;
    });
    if (emergencyMissing) {
      showError(emergency, 'Please fill in all emergency contact details.');
      errors.push(emergency);
    }

    // Scroll to first error
    if (errors.length > 0) {
      errors[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
      return false;
    }
    return true;
  }

  // Submit form as JSON to bypass Vercel's cross-site form POST restriction
  const form = document.querySelector('.onboarding-form') as HTMLFormElement;
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!validateForm()) return;

    const btn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'Submitting...';
    btn.disabled = true;

    try {
      const formData = new FormData(form);
      const fields: Record<string, string> = {};
      const attachments: { filename: string; data: string }[] = [];

      for (const [key, value] of formData.entries()) {
        if (value instanceof File && value.size > 0) {
          const data = await fileToBase64(value);
          attachments.push({ filename: value.name, data });
        } else if (typeof value === 'string' && value.trim() !== '') {
          fields[key] = value;
        }
      }

      const res = await fetch('/api/onboarding', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fields, attachments }),
      });

      const data = await res.json();
      if (data.success) {
        window.location.href = '/onboarding/thanks';
      } else {
        throw new Error(data.error || 'Submission failed');
      }
    } catch (err) {
      btn.innerHTML = originalText;
      btn.disabled = false;
      alert('There was an error submitting the form. Please try again or email alex@bolt-search.com directly.');
    }
  });
</script>

<style>
  .onboarding-hero {
    padding: var(--space-3xl) 0 var(--space-xl);
  }

  .onboarding-hero h1 {
    font-size: clamp(1.75rem, 4vw, 2.5rem);
  }

  .onboarding-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-2xl);
  }

  fieldset {
    border: 1px solid var(--color-border);
    border-radius: 12px;
    padding: var(--space-xl);
    background: var(--color-bg-elevated);
  }

  legend {
    font-size: 1.125rem;
    font-weight: 600;
    padding: 0 var(--space-sm);
    color: var(--color-fg);
  }

  .legend-note {
    font-size: 0.875rem;
    font-weight: 400;
    color: var(--color-fg-subtle);
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-lg);
  }

  .full-width {
    grid-column: 1 / -1;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .form-group label {
    font-weight: 500;
    font-size: 0.9375rem;
    color: var(--color-fg);
  }

  .required {
    color: #DC2626;
  }

  .form-group input[type="text"],
  .form-group input[type="email"],
  .form-group input[type="tel"],
  .form-group input[type="date"],
  .form-group textarea,
  .form-group select {
    padding: 0.875rem 1rem;
    border: 1px solid var(--color-border-strong);
    border-radius: 8px;
    font-family: inherit;
    font-size: 1rem;
    color: var(--color-fg);
    background: var(--color-bg);
    transition: all 0.2s ease;
  }

  .form-group input:focus,
  .form-group textarea:focus,
  .form-group select:focus {
    outline: none;
    border-color: var(--color-accent);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .form-group textarea {
    resize: vertical;
    font-family: inherit;
  }

  .form-group input[type="file"] {
    padding: 0.75rem;
    border: 2px dashed var(--color-border-strong);
    border-radius: 8px;
    background: var(--color-bg-subtle);
    cursor: pointer;
    font-size: 0.9375rem;
    transition: border-color 0.2s ease;
  }

  .form-group input[type="file"]:hover {
    border-color: var(--color-accent);
  }

  .form-hint {
    font-size: 0.8125rem;
    color: var(--color-fg-subtle);
  }

  .radio-group {
    display: flex;
    gap: var(--space-lg);
    flex-wrap: wrap;
  }

  .radio-label {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    cursor: pointer;
    font-weight: 400;
    font-size: 0.9375rem;
  }

  .radio-label input[type="radio"] {
    width: 18px;
    height: 18px;
    accent-color: var(--color-accent);
    cursor: pointer;
  }

  .conditional-section {
    margin-top: var(--space-xl);
    padding-top: var(--space-xl);
    border-top: 1px solid var(--color-border);
  }

  .conditional-section h4 {
    margin-bottom: var(--space-lg);
    font-size: 1rem;
    color: var(--color-fg-muted);
  }

  .form-submit {
    text-align: center;
  }

  .form-disclaimer {
    margin-top: var(--space-md);
    font-size: 0.8125rem;
    color: var(--color-fg-subtle);
  }

  .field-error {
    color: #DC2626;
    font-size: 0.875rem;
    font-weight: 500;
    margin: var(--space-sm) 0 0 0;
    padding: 0.5rem 0.75rem;
    background: #FEF2F2;
    border-left: 3px solid #DC2626;
    border-radius: 4px;
  }

  fieldset.fieldset-error {
    border-color: #DC2626;
    box-shadow: 0 0 0 1px #DC2626;
  }

  @media (max-width: 768px) {
    .form-grid {
      grid-template-columns: 1fr;
    }

    .radio-group {
      flex-direction: column;
      gap: var(--space-sm);
    }

    fieldset {
      padding: var(--space-lg);
    }
  }
</style>
